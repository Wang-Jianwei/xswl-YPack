<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YPack Web UI - Visual Installer Builder</title>
    
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: #409EFF;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Main Layout */
        .main-layout {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Left Panel - Properties Editor */
        .left-panel {
            width: 350px;
            border-right: 1px solid #DCDFE6;
            overflow-y: auto;
            background: #F5F7FA;
            transition: width 160ms ease, opacity 160ms ease;
            position: relative;
        }

        /* Collapsed left panel (icons-only) */
        .left-panel.collapsed {
            width: 56px;
            overflow: visible;
        }
        .left-panel.collapsed .form-section { display: none; }
        .left-panel .left-collapse-bar { display: none; }
        .left-panel.collapsed .left-collapse-bar { display: flex; align-items: center; justify-content: center; height: 48px; }

        /* Hidden right preview */
        .right-panel.collapsed { width: 0; min-width: 0; padding: 0; opacity: 0; overflow: hidden; }

        /* Compact variant */
        .compact .left-panel { width: 260px; }
        .compact .right-panel { width: 320px; }
        .compact .form-section { margin: 10px; padding: 12px; }
        .compact .form-section h3 { font-size: 14px; padding-bottom: 6px; }
        .compact .file-item { padding: 6px 8px; }
        .compact .file-list { border-radius: 3px; }
        .compact .header { padding: 8px 12px; }
        .compact .header h1 { font-size: 16px; }

        /* Center Panel - Editor */
        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .editor-tabs {
            border-bottom: 1px solid #DCDFE6;
        }
        
        .editor-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #yaml-editor {
            width: 100%;
            height: 100%;
            min-height: 260px; /* ensure editor is visible even if parent flex calculations go wrong */
            display: block;
        }
        
        /* Right Panel - Preview */
        .right-panel {
            width: 400px;
            border-left: 1px solid #DCDFE6;
            display: flex;
            flex-direction: column;
            background: #F5F7FA;
        }
        
        .preview-header {
            padding: 15px;
            border-bottom: 1px solid #DCDFE6;
            background: white;
        }
        
        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .yaml-preview {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Form Sections */
        .form-section {
            background: white;
            margin: 15px;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .form-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #303133;
            border-bottom: 2px solid #409EFF;
            padding-bottom: 8px;
        }
        
        .form-item {
            margin-bottom: 15px;
        }
        
        /* File List */
        .file-list {
            border: 1px solid #DCDFE6;
            border-radius: 4px;
            background: #FAFAFA;
        }
        
        .file-item {
            padding: 8px 12px;
            border-bottom: 1px solid #EBEEF5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-item:hover {
            background: #F5F7FA;
        }

        /* Drag handle and editing state */
        .drag-handle { cursor: move; color: #909399; margin-right: 8px; }
        .file-item.editing { background: #fff8e1; }
        .inline-input { min-width: 120px; margin-right: 8px; }
        .small-action { padding: 2px 6px; font-size: 12px; }
        .search-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
        .muted-note { font-size:12px; color:#909399; margin-left:8px; }
        .validation-error { color:#f56c6c; font-size:12px; margin-left:8px; }
        
        /* Status Bar */
        .status-bar {
            height: 28px;
            background: #F5F7FA;
            border-top: 1px solid #DCDFE6;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            color: #606266;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.valid {
            background: #67C23A;
        }
        
        .status-dot.invalid {
            background: #F56C6C;
        }

        /* Visual editor */
        .visual-editor { height: 100%; }
        .visual-comp:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.06); }
        .visual-comp { transition: box-shadow 0.12s ease; }
        .visual-comp.invalid { border-color: #F56C6C; }
        .visual-comp .visual-hint { font-size: 12px; color: #F56C6C; }
        .visual-comp.invalid { border-color: #F56C6C; }
        .visual-comp .visual-hint { font-size: 12px; color: #F56C6C; }
    </style>
</head>
<body>
    <div id="app" :class="{ compact: compactMode }">
        <!-- Header -->
        <div class="header">
            <h1>üì¶ YPack - Visual Installer Builder</h1>
            <div class="header-actions">
                <el-button type="primary" size="small" @click="newProject" plain>Êñ∞Âª∫</el-button>
                <el-button type="primary" size="small" @click="loadYamlFile">ÊâìÂºÄ</el-button>
                <el-button type="success" size="small" @click="downloadYaml">‰øùÂ≠ò YAML</el-button>
                <el-button size="small" :type="compactMode ? 'warning' : 'info'" @click="toggleCompact" plain>
                    <i :class="compactMode ? 'el-icon-full-screen' : 'el-icon-fa-compress'" style="margin-right:6px"></i>
                    {{ compactMode ? 'Â∏∏ËßÑÊ®°Âºè' : 'Á¥ßÂáëÊ®°Âºè' }}
                </el-button>
                <el-button size="small" :type="leftCollapsed ? 'primary' : 'default'" @click="toggleLeftCollapse" plain title="ÊäòÂè†/Â±ïÂºÄÂ∑¶‰æßÈù¢Êùø">‚óÄ</el-button>
                <el-button size="small" :type="rightCollapsed ? 'primary' : 'default'" @click="toggleRightCollapse" plain title="ÈöêËóè/ÊòæÁ§∫ YAML È¢ÑËßà">‚ñ£</el-button>
            </div>
        </div>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Panel: Properties Editor -->
            <div class="left-panel" :class="{collapsed: leftCollapsed}">
                <div class="left-collapse-bar" v-if="leftCollapsed" style="height:48px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #e6e6e6;background:#fafafa;">
                    <el-button size="mini" @click="toggleLeftCollapse">‚ñ∂</el-button>
                </div>
                <!-- App Info Section -->
                <div class="form-section">
                    <h3>üì± Â∫îÁî®‰ø°ÊÅØ</h3>
                    <el-form label-width="100px" size="small">
                        <el-form-item label="Â∫îÁî®ÂêçÁß∞">
                            <el-input v-model="config.app.name" placeholder="MyApp" @input="onConfigChange"></el-input>
                        </el-form-item>
                        <el-form-item label="ÁâàÊú¨Âè∑">
                            <el-input v-model="config.app.version" placeholder="1.0.0" @input="onConfigChange"></el-input>
                        </el-form-item>
                        <el-form-item label="ÂèëÂ∏ÉËÄÖ">
                            <el-input v-model="config.app.publisher" placeholder="Example Co." @input="onConfigChange"></el-input>
                        </el-form-item>
                        <el-form-item label="ÊèèËø∞">
                            <el-input v-model="config.app.description" type="textarea" :rows="2" @input="onConfigChange"></el-input>
                        </el-form-item>
                        <el-form-item label="ÂÆâË£ÖÂõæÊ†á">
                            <el-input v-model="config.app.install_icon" placeholder="path/to/icon.ico" @input="onConfigChange"></el-input>
                        </el-form-item>
                    </el-form>
                </div>
                
                <!-- Install Settings Section -->
                <div class="form-section">
                    <h3>‚öôÔ∏è ÂÆâË£ÖËÆæÁΩÆ</h3>
                    <el-form label-width="100px" size="small">
                        <el-form-item label="ÂÆâË£ÖÁõÆÂΩï">
                            <el-input v-model="config.install.install_dir" placeholder="$PROGRAMFILES64\MyApp" @input="onConfigChange"></el-input>
                        </el-form-item>
                        <el-form-item label="Ê≥®ÂÜåË°®ÈîÆ">
                            <el-input v-model="config.install.registry_key" placeholder="Software\Publisher\App" @input="onConfigChange"></el-input>
                        </el-form-item>
                    </el-form>
                </div>
                
                <!-- Files Section -->
                <div class="form-section">
                    <h3>üìÅ Êñá‰ª∂ÂàóË°®</h3>
                    <div class="file-list" v-if="config.files && config.files.length">
                        <div class="file-item" v-for="(file, index) in config.files" :key="index">
                            <span>{{ typeof file === 'string' ? file : file.source }}</span>
                            <el-button type="danger" size="small" text @click="removeFile(index)">Âà†Èô§</el-button>
                        </div>
                    </div>
                    <div v-else style="text-align: center; color: #909399; padding: 20px;">
                        ÊöÇÊó†Êñá‰ª∂
                    </div>
                    <el-button type="primary" size="small" plain style="width: 100%; margin-top: 10px;" @click="addFile">
                        + Ê∑ªÂä†Êñá‰ª∂
                    </el-button>
                </div>

                <!-- Registry Section -->
                <div class="form-section">
                    <h3>üìù Ê≥®ÂÜåË°®È°π</h3>

                    <div class="search-row">
                        <el-input size="small" v-model="registrySearch" clearable placeholder="ÊêúÁ¥¢Ê≥®ÂÜåË°®ÔºàÈîÆ/Âêç/ÂÄºÔºâ">
                            <template #prefix>
                                <i class="el-icon-search"></i>
                            </template>
                        </el-input>
                        <el-button size="small" type="text" @click="registrySearch = ''">ÈáçÁΩÆ</el-button>
                        <div class="muted-note">ÂÖ± {{ config.install?.registry?.length || 0 }} È°π</div>
                    </div>

                    <div class="file-list" v-if="filteredRegistry.length">
                        <div class="file-item" v-for="entry in filteredRegistry" :key="entry.index" :class="{editing: editingRegistryIndex === entry.index}"
                             draggable="true" @dragstart.prevent="onListDragStart('registry', entry.index, $event)" @dragover.prevent @drop.prevent="onListDrop('registry', entry.index, $event)">
                            <div style="display:flex;align-items:center;flex:1;gap:8px">
                                <i class="el-icon-rank drag-handle" aria-hidden="true"></i>

                                <div v-if="editingRegistryIndex === entry.index" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                                    <el-select size="small" v-model="registryForm.hive" class="inline-input">
                                        <el-option label="HKLM" value="HKLM"></el-option>
                                        <el-option label="HKCU" value="HKCU"></el-option>
                                        <el-option label="HKCR" value="HKCR"></el-option>
                                        <el-option label="HKU" value="HKU"></el-option>
                                    </el-select>
                                    <el-input size="small" class="inline-input" v-model="registryForm.key" placeholder="ÈîÆË∑ØÂæÑ"></el-input>
                                    <el-input size="small" class="inline-input" v-model="registryForm.name" placeholder="ÂÄºÂêç"></el-input>
                                    <el-input size="small" class="inline-input" v-model="registryForm.value" placeholder="ÂÄº"></el-input>
                                    <el-select size="small" v-model="registryForm.type" class="inline-input">
                                        <el-option label="REG_SZ" value="REG_SZ"></el-option>
                                        <el-option label="REG_DWORD" value="REG_DWORD"></el-option>
                                    </el-select>
                                    <el-button size="mini" type="primary" class="small-action" @click="saveInlineRegistry(entry.index)">‰øùÂ≠ò</el-button>
                                    <el-button size="mini" class="small-action" @click="cancelInlineRegistry">ÂèñÊ∂à</el-button>
                                    <div v-if="(!registryForm.key || !registryForm.name)" class="validation-error">ÈîÆË∑ØÂæÑ & ÂÄºÂêçÁß∞‰∏∫ÂøÖÂ°´</div>
                                </div>

                                <div v-else style="flex:1;display:flex;align-items:center;justify-content:space-between">
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <strong style="font-size:13px">{{ entry.item.hive }}\{{ entry.item.key }}\{{ entry.item.name }}</strong>
                                        <span class="muted-note">{{ entry.item.value }}</span>
                                    </div>
                                    <div>
                                        <el-button type="text" size="small" @click="startInlineRegistry(entry.index)">ÁºñËæë</el-button>
                                        <el-button type="danger" size="small" text @click="removeRegistry(entry.index)">Âà†Èô§</el-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else style="text-align: center; color: #909399; padding: 20px;">ÊöÇÊó†Ê≥®ÂÜåË°®È°π</div>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <el-button type="primary" size="small" plain style="flex:1" @click="addRegistry">+ Ê∑ªÂä†Ê≥®ÂÜåË°®</el-button>
                        <el-button size="small" @click="moveRegistryUp">‚ñ≤</el-button>
                        <el-button size="small" @click="moveRegistryDown">‚ñº</el-button>
                    </div>
                </div>

                <!-- Environment Variables Section -->
                <div class="form-section">
                    <h3>üåç ÁéØÂ¢ÉÂèòÈáè</h3>

                    <div class="search-row">
                        <el-input size="small" v-model="envSearch" clearable placeholder="ÊêúÁ¥¢ÁéØÂ¢ÉÂèòÈáèÔºàÂêç/ÂÄºÔºâ">
                            <template #prefix>
                                <i class="el-icon-search"></i>
                            </template>
                        </el-input>
                        <el-button size="small" type="text" @click="envSearch = ''">ÈáçÁΩÆ</el-button>
                        <div class="muted-note">ÂÖ± {{ config.install?.env_vars?.length || 0 }} È°π</div>
                    </div>

                    <div class="file-list" v-if="filteredEnvVars.length">
                        <div class="file-item" v-for="entry in filteredEnvVars" :key="entry.index" :class="{editing: editingEnvVarIndex === entry.index}"
                             draggable="true" @dragstart.prevent="onListDragStart('env', entry.index, $event)" @dragover.prevent @drop.prevent="onListDrop('env', entry.index, $event)">
                            <div style="display:flex;align-items:center;flex:1;gap:8px">
                                <i class="el-icon-rank drag-handle" aria-hidden="true"></i>

                                <div v-if="editingEnvVarIndex === entry.index" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                                    <el-input size="small" class="inline-input" v-model="envVarForm.name" placeholder="ÂèòÈáèÂêç"></el-input>
                                    <el-input size="small" class="inline-input" v-model="envVarForm.value" placeholder="ÂèòÈáèÂÄº"></el-input>
                                    <el-select size="small" v-model="envVarForm.scope" class="inline-input">
                                        <el-option label="user" value="user"></el-option>
                                        <el-option label="system" value="system"></el-option>
                                    </el-select>
                                    <el-switch size="small" v-model="envVarForm.append"></el-switch>
                                    <el-button size="mini" type="primary" class="small-action" @click="saveInlineEnvVar(entry.index)">‰øùÂ≠ò</el-button>
                                    <el-button size="mini" class="small-action" @click="cancelInlineEnvVar">ÂèñÊ∂à</el-button>
                                    <div v-if="!envVarForm.name || !envVarForm.value" class="validation-error">ÂèòÈáèÂêçÂíåÂÄº‰∏∫ÂøÖÂ°´</div>
                                </div>

                                <div v-else style="flex:1;display:flex;align-items:center;justify-content:space-between">
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <strong style="font-size:13px">{{ entry.item.name }}</strong>
                                        <span class="muted-note">{{ entry.item.value }}</span>
                                    </div>
                                    <div>
                                        <el-button type="text" size="small" @click="startInlineEnvVar(entry.index)">ÁºñËæë</el-button>
                                        <el-button type="danger" size="small" text @click="removeEnvVar(entry.index)">Âà†Èô§</el-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else style="text-align: center; color: #909399; padding: 20px;">ÊöÇÊó†ÁéØÂ¢ÉÂèòÈáè</div>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <el-button type="primary" size="small" plain style="flex:1" @click="addEnvVar">+ Ê∑ªÂä†ÁéØÂ¢ÉÂèòÈáè</el-button>
                        <el-button size="small" @click="moveEnvUp">‚ñ≤</el-button>
                        <el-button size="small" @click="moveEnvDown">‚ñº</el-button>
                    </div>
                </div>

                <!-- Shortcuts Section -->
                <div class="form-section">
                    <h3>üîó Âø´Êç∑ÊñπÂºè</h3>

                    <div class="search-row">
                        <el-input size="small" v-model="shortcutSearch" clearable placeholder="ÊêúÁ¥¢Âø´Êç∑ÊñπÂºèÔºàÂêçÁß∞/ÁõÆÊ†áÔºâ">
                            <template #prefix>
                                <i class="el-icon-search"></i>
                            </template>
                        </el-input>
                        <el-button size="small" type="text" @click="shortcutSearch = ''">ÈáçÁΩÆ</el-button>
                        <div class="muted-note">ÂÖ± {{ config.shortcuts?.length || 0 }} È°π</div>
                    </div>

                    <div class="file-list" v-if="filteredShortcuts.length">
                        <div class="file-item" v-for="entry in filteredShortcuts" :key="entry.index" :class="{editing: editingShortcutIndex === entry.index}"
                             draggable="true" @dragstart.prevent="onListDragStart('shortcut', entry.index, $event)" @dragover.prevent @drop.prevent="onListDrop('shortcut', entry.index, $event)">
                            <div style="display:flex;align-items:center;flex:1;gap:8px">
                                <i class="el-icon-rank drag-handle" aria-hidden="true"></i>

                                <div v-if="editingShortcutIndex === entry.index" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                                    <el-input size="small" class="inline-input" v-model="shortcutForm.name" placeholder="ÂêçÁß∞"></el-input>
                                    <el-input size="small" class="inline-input" v-model="shortcutForm.target" placeholder="ÁõÆÊ†áË∑ØÂæÑ"></el-input>
                                    <el-input size="small" class="inline-input" v-model="shortcutForm.args" placeholder="ÂèÇÊï∞"></el-input>
                                    <el-button size="mini" type="primary" class="small-action" @click="saveInlineShortcut(entry.index)">‰øùÂ≠ò</el-button>
                                    <el-button size="mini" class="small-action" @click="cancelInlineShortcut">ÂèñÊ∂à</el-button>
                                    <div v-if="!shortcutForm.name || !shortcutForm.target" class="validation-error">ÂêçÁß∞ÂíåÁõÆÊ†á‰∏∫ÂøÖÂ°´</div>
                                </div>

                                <div v-else style="flex:1;display:flex;align-items:center;justify-content:space-between">
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <strong style="font-size:13px">{{ entry.item.name || entry.item.target }}</strong>
                                        <span class="muted-note">{{ entry.item.target }}</span>
                                    </div>
                                    <div>
                                        <el-button type="text" size="small" @click="startInlineShortcut(entry.index)">ÁºñËæë</el-button>
                                        <el-button type="danger" size="small" text @click="removeShortcut(entry.index)">Âà†Èô§</el-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else style="text-align: center; color: #909399; padding: 20px;">ÊöÇÊó†Âø´Êç∑ÊñπÂºè</div>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <el-button type="primary" size="small" plain style="flex:1" @click="addShortcut">+ Ê∑ªÂä†Âø´Êç∑ÊñπÂºè</el-button>
                        <el-button size="small" @click="moveShortcutUp">‚ñ≤</el-button>
                        <el-button size="small" @click="moveShortcutDown">‚ñº</el-button>
                    </div>
                </div>
            </div>
            
            <!-- Center Panel: YAML Editor -->
            <div class="center-panel">
                <el-tabs v-model="activeTab" class="editor-tabs">
                    <el-tab-pane label="YAML ÁºñËæëÂô®" name="yaml">
                        <div class="editor-content">
                            <div id="yaml-editor"></div>
                        </div>
                    </el-tab-pane>

                    <el-tab-pane label="ÂèØËßÜÂåñ" name="visual">
                        <div class="editor-content visual-editor">
                            <div style="display:flex;height:100%">
                                <!-- Palette -->
                                <div style="width:200px;padding:10px;border-right:1px solid #eee;background:#fafafa">
                                    <h4 style="margin-bottom:10px">ÁªÑ‰ª∂Â∫ì</h4>
                                    <div draggable="true" data-testid="visual-palette-file" @dragstart="onDragStart($event,'file')" style="padding:8px;border:1px dashed #dcdfe6;border-radius:4px;margin-bottom:8px;cursor:grab">Êñá‰ª∂ (File)</div>
                                    <div draggable="true" data-testid="visual-palette-shortcut" @dragstart="onDragStart($event,'shortcut')" style="padding:8px;border:1px dashed #dcdfe6;border-radius:4px;margin-bottom:8px;cursor:grab">Âø´Êç∑ÊñπÂºè (Shortcut)</div>
                                    <div draggable="true" data-testid="visual-palette-folder" @dragstart="onDragStart($event,'folder')" style="padding:8px;border:1px dashed #dcdfe6;border-radius:4px;margin-bottom:8px;cursor:grab">Êñá‰ª∂Â§π (Folder)</div>
                                    <el-button type="primary" size="small" style="margin-top:12px;" data-testid="visual-apply" @click="applyVisualToConfig">Â∞ÜÂèØËßÜÂåñÈ°πÂ∫îÁî®Âà∞ÈÖçÁΩÆ</el-button>
                                </div>

                                <!-- Canvas -->
                                <div style="flex:1;padding:10px;position:relative" data-testid="visual-canvas" @dragover.prevent @drop="onDrop($event)">
                                    <h4 style="margin-top:0">ÁîªÂ∏É</h4>
                                    <div v-if="visualComponents.length===0" style="color:#909399;padding:20px">Â∞ÜÁªÑ‰ª∂‰ªéÂ∑¶‰æßÊãñÊîæÂà∞Ê≠§Â§Ñ‰ª•ÂàõÂª∫ÂèØËßÜÂåñÈ°π</div>
                                    <div v-for="(c, i) in visualComponents" :key="i" :class="['visual-comp', getVisualStatus(c).valid ? '' : 'invalid']" :data-testid="`visual-comp-${i}`" style="padding:8px;border:1px solid #EBEEF5;margin:6px;border-radius:4px;background:white;display:flex;justify-content:space-between;align-items:center">
                                        <div>
                                            <strong>{{ c.type }}</strong>
                                            <div style="font-size:12px;color:#909399">{{ c.props.source || c.props.name || 'Êú™ËÆæÁΩÆ' }}</div>
                                            <div v-if="!getVisualStatus(c).valid" class="visual-hint">{{ getVisualStatus(c).message }}</div>
                                        </div>
                                        <div>
                                            <el-button type="text" size="mini" @click="editVisual(i)">ÁºñËæë</el-button>
                                            <el-button type="text" size="mini" @click="removeVisual(i)">Âà†Èô§</el-button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>
            
            <!-- Right Panel: Preview -->
            <div class="right-panel" :class="{collapsed: rightCollapsed}">
                <div class="preview-header">
                    <h3 style="font-size: 14px; margin-bottom: 10px;">üìÑ YAML È¢ÑËßà</h3>
                    <el-button type="primary" size="small" @click="validateYaml" style="width: 100%;">
                        È™åËØÅÈÖçÁΩÆ
                    </el-button>
                </div>
                <div class="preview-content">
                    <div class="yaml-preview" data-testid="yaml-preview">{{ yamlPreview }}</div>
                </div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" :class="validationStatus.valid ? 'valid' : 'invalid'"></div>
                <span>{{ validationStatus.message }}</span>
            </div>
        </div>
        
        <!-- Add File Dialog -->
        <el-dialog v-model="addFileDialog" title="Ê∑ªÂä†Êñá‰ª∂" width="500px">
            <el-form label-width="80px">
                <el-form-item label="Ê∫êË∑ØÂæÑ">
                    <el-input v-model="newFile.source" placeholder="bin/MyApp.exe"></el-input>
                </el-form-item>
                <el-form-item label="ÁõÆÊ†áË∑ØÂæÑ">
                    <el-input v-model="newFile.destination" placeholder="$INSTDIR"></el-input>
                </el-form-item>
                <el-form-item label="ÈÄíÂΩí">
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="addFileDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="confirmAddFile">Á°ÆÂÆö</el-button>
            </template>
        </el-dialog>

        <!-- Visual Component Dialog -->
        <el-dialog v-model="visualEditDialog" title="ÁºñËæëÂèØËßÜÂåñÈ°π" width="520px" data-testid="visual-edit-dialog">
            <el-form label-width="90px">
                <el-form-item label="Á±ªÂûã">
                    <el-select v-model="visualForm.type" disabled style="width: 100%;">
                        <el-option label="Êñá‰ª∂" value="file"></el-option>
                        <el-option label="Êñá‰ª∂Â§π" value="folder"></el-option>
                        <el-option label="Âø´Êç∑ÊñπÂºè" value="shortcut"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="Ê∫êË∑ØÂæÑ" v-if="visualForm.type !== 'shortcut'">
                    <el-input v-model="visualForm.source" placeholder="bin/MyApp.exe" data-testid="visual-source"></el-input>
                </el-form-item>
                <el-form-item label="ÁõÆÊ†áË∑ØÂæÑ" v-if="visualForm.type !== 'shortcut'">
                    <el-input v-model="visualForm.destination" placeholder="$INSTDIR" data-testid="visual-destination"></el-input>
                </el-form-item>
                <el-form-item label="ÈÄíÂΩí" v-if="visualForm.type === 'folder'">
                    <el-switch v-model="visualForm.recursive" data-testid="visual-recursive"></el-switch>
                </el-form-item>
                <el-form-item label="ÂêçÁß∞" v-if="visualForm.type === 'shortcut'">
                    <el-input v-model="visualForm.name" placeholder="MyApp" data-testid="visual-name"></el-input>
                </el-form-item>
                <el-form-item label="ÁõÆÊ†á" v-if="visualForm.type === 'shortcut'">
                    <el-input v-model="visualForm.target" placeholder="$INSTDIR\\MyApp.exe" data-testid="visual-target"></el-input>
                </el-form-item>
                <el-form-item label="ÂèÇÊï∞" v-if="visualForm.type === 'shortcut'">
                    <el-input v-model="visualForm.args" placeholder="--help" data-testid="visual-args"></el-input>
                </el-form-item>
                <el-form-item label="ÂõæÊ†á" v-if="visualForm.type === 'shortcut'">
                    <el-input v-model="visualForm.icon" placeholder="path/to/icon.ico" data-testid="visual-icon"></el-input>
                </el-form-item>
                <el-form-item label="ËØ¥Êòé">
                    <el-input v-model="visualForm.description" type="textarea" :rows="2" data-testid="visual-description"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="visualEditDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" data-testid="visual-save" @click="saveVisualEdit">‰øùÂ≠ò</el-button>
            </template>
        </el-dialog>

        <!-- Registry Entry Dialog -->
        <el-dialog v-model="registryDialog" title="Ê∑ªÂä†/ÁºñËæëÊ≥®ÂÜåË°®È°π" width="500px">
            <el-form :model="registryForm" label-width="100px">
                <el-form-item label="Ê†πÈîÆ">
                    <el-select v-model="registryForm.hive" placeholder="ÈÄâÊã©Ê†πÈîÆ">
                        <el-option label="HKEY_LOCAL_MACHINE" value="HKLM"></el-option>
                        <el-option label="HKEY_CURRENT_USER" value="HKCU"></el-option>
                        <el-option label="HKEY_CLASSES_ROOT" value="HKCR"></el-option>
                        <el-option label="HKEY_USERS" value="HKU"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="ÈîÆË∑ØÂæÑ">
                    <el-input v-model="registryForm.key" placeholder="Â¶Ç: Software\\MyApp"></el-input>
                </el-form-item>
                <el-form-item label="ÂÄºÂêçÁß∞">
                    <el-input v-model="registryForm.name" placeholder="Â¶Ç: InstallPath"></el-input>
                </el-form-item>
                <el-form-item label="ÂÄºÊï∞ÊçÆ">
                    <el-input v-model="registryForm.value" placeholder="ÂÄº"></el-input>
                </el-form-item>
                <el-form-item label="Á±ªÂûã">
                    <el-select v-model="registryForm.type" placeholder="ÈÄâÊã©Á±ªÂûã">
                        <el-option label="Â≠óÁ¨¶‰∏≤ (REG_SZ)" value="REG_SZ"></el-option>
                        <el-option label="Êï¥Êï∞ (REG_DWORD)" value="REG_DWORD"></el-option>
                        <el-option label="Êâ©Â±ïÂ≠óÁ¨¶‰∏≤ (REG_EXPAND_SZ)" value="REG_EXPAND_SZ"></el-option>
                        <el-option label="Â§öË°åÂ≠óÁ¨¶‰∏≤ (REG_MULTI_SZ)" value="REG_MULTI_SZ"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="ËßÜÂõæ">
                    <el-select v-model="registryForm.view" placeholder="ÈÄâÊã©ËßÜÂõæ">
                        <el-option label="ÈªòËÆ§" value=""></el-option>
                        <el-option label="64‰Ωç" value="64"></el-option>
                        <el-option label="32‰Ωç" value="32"></el-option>
                    </el-select>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="registryDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="confirmRegistry">‰øùÂ≠ò</el-button>
            </template>
        </el-dialog>

        <!-- Environment Variable Dialog -->
        <el-dialog v-model="envVarDialog" title="Ê∑ªÂä†/ÁºñËæëÁéØÂ¢ÉÂèòÈáè" width="500px">
            <el-form :model="envVarForm" label-width="100px">
                <el-form-item label="ÂèòÈáèÂêç">
                    <el-input v-model="envVarForm.name" placeholder="Â¶Ç: PATH"></el-input>
                </el-form-item>
                <el-form-item label="ÂèòÈáèÂÄº">
                    <el-input v-model="envVarForm.value" placeholder="ÂÄº"></el-input>
                </el-form-item>
                <el-form-item label="‰ΩúÁî®Âüü">
                    <el-select v-model="envVarForm.scope" placeholder="ÈÄâÊã©‰ΩúÁî®Âüü">
                        <el-option label="Áî®Êà∑" value="user"></el-option>
                        <el-option label="Á≥ªÁªü" value="system"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="ËøΩÂä†Ê®°Âºè">
                    <el-switch v-model="envVarForm.append"></el-switch>
                    <span style="margin-left: 10px; font-size: 12px; color: #999;">ÂºÄÂêØÊó∂ËøΩÂä†Âà∞Â∑≤ÊúâÂèòÈáè,ÂÖ≥Èó≠Êó∂Ë¶ÜÁõñ</span>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="envVarDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="confirmEnvVar">‰øùÂ≠ò</el-button>
            </template>
        </el-dialog>

        <!-- Shortcut Dialog -->
        <el-dialog v-model="shortcutDialog" title="Ê∑ªÂä†/ÁºñËæëÂø´Êç∑ÊñπÂºè" width="500px">
            <el-form :model="shortcutForm" label-width="100px">
                <el-form-item label="ÂêçÁß∞">
                    <el-input v-model="shortcutForm.name" placeholder="Âø´Êç∑ÊñπÂºèÂêçÁß∞"></el-input>
                </el-form-item>
                <el-form-item label="ÁõÆÊ†áË∑ØÂæÑ">
                    <el-input v-model="shortcutForm.target" placeholder="Â¶Ç: $INSTDIR\\app.exe"></el-input>
                </el-form-item>
                <el-form-item label="ÂèÇÊï∞">
                    <el-input v-model="shortcutForm.args" placeholder="ÂêØÂä®ÂèÇÊï∞(ÂèØÈÄâ)"></el-input>
                </el-form-item>
                <el-form-item label="ÂõæÊ†áË∑ØÂæÑ">
                    <el-input v-model="shortcutForm.icon" placeholder="ÂõæÊ†áÊñá‰ª∂Ë∑ØÂæÑ(ÂèØÈÄâ)"></el-input>
                </el-form-item>
                <el-form-item label="ÊèèËø∞">
                    <el-input v-model="shortcutForm.description" placeholder="ÊèèËø∞‰ø°ÊÅØ(ÂèØÈÄâ)"></el-input>
                </el-form-item>
                <el-form-item label="Â∑•‰ΩúÁõÆÂΩï">
                    <el-input v-model="shortcutForm.working_dir" placeholder="Â∑•‰ΩúÁõÆÂΩï(ÂèØÈÄâ)"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="shortcutDialog = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="confirmShortcut">‰øùÂ≠ò</el-button>
            </template>
        </el-dialog>
    </div>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.3.11/dist/vue.global.prod.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.js"></script>
    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <!-- js-yaml -->
    <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
    
    <script>
        const { createApp, ref, reactive, watch, onMounted, computed } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        // Accessibility: keyboard shortcut for compact toggle (Alt+K)
        document.addEventListener('keydown', (e) => {
            if (e.altKey && e.key.toLowerCase() === 'k') {
                // will be handled inside Vue via compactMode binding
                const appRoot = document.getElementById('app');
                if (appRoot && appRoot.__vue_app__) {
                    try { appRoot.__vue_app__._instance.ctx.toggleCompact(); } catch (err) {}
                }
            }
        });
        
        const API_BASE = 'http://127.0.0.1:5000/api';
        
        createApp({
            setup() {
                // State
                const activeTab = ref('yaml');
                const addFileDialog = ref(false);
                const registryDialog = ref(false);
                const envVarDialog = ref(false);
                const shortcutDialog = ref(false);
                const compactMode = ref(false);

                // collapse state to enlarge center canvas
                const leftCollapsed = ref(false);
                const rightCollapsed = ref(false);
                const autoCollapseOnVisual = ref(true);
                
                const config = reactive({
                    app: {
                        name: 'MyApp',
                        version: '1.0.0',
                        publisher: '',
                        description: '',
                        install_icon: ''
                    },
                    install: {
                        install_dir: '$PROGRAMFILES64\\MyApp',
                        registry_key: ''
                    },
                    files: []
                });
                
                const newFile = reactive({
                    source: '',
                    destination: '$INSTDIR',
                });
                
                const registryForm = reactive({
                    hive: 'HKLM',
                    key: '',
                    name: '',
                    value: '',
                    type: 'REG_SZ',
                    view: ''
                });
                
                const envVarForm = reactive({
                    name: '',
                    value: '',
                    scope: 'user',
                    append: false
                });
                
                const shortcutForm = reactive({
                    name: '',
                    target: '',
                    args: '',
                    icon: '',
                    description: '',
                    working_dir: ''
                });
                
                let editingRegistryIndex = -1;
                let editingEnvVarIndex = -1;
                let editingShortcutIndex = -1;

                // Search/filter inputs
                const registrySearch = ref('');
                const envSearch = ref('');
                const shortcutSearch = ref('');

                // Drag state for reordering
                const dragState = reactive({ section: '', index: -1 });

                // Filtered computed lists that preserve original index
                const filteredRegistry = computed(() => {
                    if (!config.install || !config.install.registry) return [];
                    return config.install.registry.map((it, i) => ({ item: it, index: i }))
                        .filter(({ item }) => !registrySearch.value || (`${item.hive} ${item.key} ${item.name} ${item.value}`).toLowerCase().includes(registrySearch.value.toLowerCase()));
                });

                const filteredEnvVars = computed(() => {
                    if (!config.install || !config.install.env_vars) return [];
                    return config.install.env_vars.map((it, i) => ({ item: it, index: i }))
                        .filter(({ item }) => !envSearch.value || (`${item.name} ${item.value}`).toLowerCase().includes(envSearch.value.toLowerCase()));
                });

                const filteredShortcuts = computed(() => {
                    if (!config.shortcuts) return [];
                    return config.shortcuts.map((it, i) => ({ item: it, index: i }))
                        .filter(({ item }) => !shortcutSearch.value || (`${item.name} ${item.target}`).toLowerCase().includes(shortcutSearch.value.toLowerCase()));
                });
                
                const yamlPreview = ref('');
                const yamlContent = ref('');
                const validationStatus = reactive({
                    valid: true,
                    message: 'Â∞±Áª™'
                });
                
                let editor = null;
                let isEditorChange = false;
                
                // Initialize Monaco Editor
                onMounted(() => {
                    require.config({ 
                        paths: { 
                            vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' 
                        } 
                    });
                    
                    require(['vs/editor/editor.main'], function() {
                        editor = monaco.editor.create(document.getElementById('yaml-editor'), {
                            value: '',
                            language: 'yaml',
                            theme: 'vs-dark',
                            automaticLayout: true,
                            minimap: { enabled: false },
                            fontSize: 14,
                            tabSize: 2
                        });

                        // Force an initial layout and add resize handler (defensive)
                        try { editor.layout(); } catch (e) { /* ignore */ }
                        window.addEventListener('resize', () => { try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) {} });

                        // Listen to editor changes
                        editor.onDidChangeModelContent(() => {
                            if (!isEditorChange) {
                                yamlContent.value = editor.getValue();
                                loadFromYaml();
                            }
                        });

                        // Initial sync
                        syncToYaml();
                    });
                });
                
                // Sync config to YAML
                async function syncToYaml() {
                    try {
                        // Persist visual components into the config so they are saved to YAML
                        try {
                            config.visual = { components: visualComponents.map(c => ({ type: c.type, props: c.props })) };
                        } catch (e) {
                            // If reactive proxy prevents direct assignment, assign safely
                            config.visual = Object.assign({}, { components: visualComponents.map(c => ({ type: c.type, props: c.props })) });
                        }

                        // Defensive: ensure editor layout after config changes that affect layout
                        setTimeout(() => { try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) {} }, 50);

                        const response = await fetch(`${API_BASE}/project/save`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ config })
                        });
                        
                        const data = await response.json();
                        yamlContent.value = data.yaml_content;
                        yamlPreview.value = data.yaml_content;
                        
                        // Update editor
                        if (editor) {
                            isEditorChange = true;
                            editor.setValue(data.yaml_content);
                            setTimeout(() => { isEditorChange = false; }, 100);
                        }
                    } catch (error) {
                        console.error('Error syncing to YAML:', error);
                    }
                }

                // -------------------- ÂèØËßÜÂåñ ÁºñËæëÂô®ÈÄªËæë --------------------
                const visualComponents = reactive([]);
                const visualEditDialog = ref(false);
                const visualEditIndex = ref(-1);
                const visualForm = reactive({
                    type: 'file',
                    source: '',
                    destination: '$INSTDIR',
                    recursive: false,
                    name: '',
                    target: '',
                    args: '',
                    icon: '',
                    description: ''
                });

                function resetVisualForm(type) {
                    visualForm.type = type || 'file';
                    visualForm.source = '';
                    visualForm.destination = '$INSTDIR';
                    visualForm.recursive = false;
                    visualForm.name = '';
                    visualForm.target = '';
                    visualForm.args = '';
                    visualForm.icon = '';
                    visualForm.description = '';
                }

                function getVisualStatus(c) {
                    if (!c || !c.type) {
                        return { valid: false, message: 'Áº∫Â∞ëÁ±ªÂûã' };
                    }
                    if (c.type === 'shortcut') {
                        if (!c.props || !c.props.name) {
                            return { valid: false, message: 'ÈúÄË¶ÅÂêçÁß∞' };
                        }
                        if (!c.props.target) {
                            return { valid: false, message: 'ÈúÄË¶ÅÁõÆÊ†á' };
                        }
                    } else {
                        if (!c.props || !c.props.source) {
                            return { valid: false, message: 'ÈúÄË¶ÅÊ∫êË∑ØÂæÑ' };
                        }
                    }
                    return { valid: true, message: '' };
                }

                function onDragStart(e, type) {
                    e.dataTransfer.setData('text/plain', type);
                }

                function onDrop(e) {
                    const type = e.dataTransfer.getData('text/plain') || 'file';
                    let props = {};
                    if (type === 'shortcut') {
                        props = { name: '', target: '', args: '', icon: '', description: '' };
                    } else {
                        props = { source: '', destination: '$INSTDIR', recursive: type === 'folder', description: '' };
                    }
                    visualComponents.push({ type: type, props: props });
                    openVisualEdit(visualComponents.length - 1);
                }

                function removeVisual(index) {
                    visualComponents.splice(index, 1);
                }

                function openVisualEdit(index) {
                    const c = visualComponents[index];
                    if (!c) return;
                    resetVisualForm(c.type);
                    if (c.props) {
                        visualForm.source = c.props.source || '';
                        visualForm.destination = c.props.destination || '$INSTDIR';
                        visualForm.recursive = Boolean(c.props.recursive);
                        visualForm.name = c.props.name || '';
                        visualForm.target = c.props.target || '';
                        visualForm.args = c.props.args || '';
                        visualForm.icon = c.props.icon || '';
                        visualForm.description = c.props.description || '';
                    }
                    visualEditIndex.value = index;
                    visualEditDialog.value = true;
                }

                function editVisual(index) {
                    openVisualEdit(index);
                }

                function saveVisualEdit() {
                    const type = visualForm.type;
                    if (type === 'shortcut') {
                        if (!visualForm.name) {
                            ElMessage.warning('ËØ∑ËæìÂÖ•ÂêçÁß∞');
                            return;
                        }
                        if (!visualForm.target) {
                            ElMessage.warning('ËØ∑ËæìÂÖ•ÁõÆÊ†á');
                            return;
                        }
                    } else if (!visualForm.source) {
                        ElMessage.warning('ËØ∑ËæìÂÖ•Ê∫êË∑ØÂæÑ');
                        return;
                    }

                    const c = visualComponents[visualEditIndex.value];
                    if (!c) return;
                    if (type === 'shortcut') {
                        c.props = {
                            name: visualForm.name,
                            target: visualForm.target,
                            args: visualForm.args,
                            icon: visualForm.icon,
                            description: visualForm.description
                        };
                    } else {
                        c.props = {
                            source: visualForm.source,
                            destination: visualForm.destination || '$INSTDIR',
                            recursive: Boolean(visualForm.recursive),
                            description: visualForm.description
                        };
                    }
                    visualEditDialog.value = false;
                }

                function applyVisualToConfig() {
                    const errors = [];
                    visualComponents.forEach((c, idx) => {
                        const status = getVisualStatus(c);
                        if (!status.valid) {
                            errors.push(`Á¨¨${idx + 1}È°π${status.message}`);
                        }
                    });
                    if (errors.length) {
                        const extra = errors.length > 1 ? `ÔºàÂÖ±${errors.length}È°πÔºâ` : '';
                        ElMessage.error(`ÂèØËßÜÂåñÈ°πÊú™ÂÆåÂñÑÔºö${errors[0]}${extra}`);
                        return;
                    }

                    // Persist visual components to config.visual for later restoration
                    try {
                        config.visual = { components: visualComponents.map(c => ({ type: c.type, props: c.props })) };
                    } catch (e) {
                        config.visual = Object.assign({}, { components: visualComponents.map(c => ({ type: c.type, props: c.props })) });
                    }

                    // Also add file-like items into config.files for compatibility with existing flows
                    if (!config.files) config.files = [];
                    visualComponents.forEach((c, idx) => {
                        if (c.type === 'file') {
                            const src = c.props.source || `visual-file-${idx + 1}.bin`;
                            const dst = c.props.destination || '$INSTDIR';
                            if (dst === '$INSTDIR' && !c.props.recursive) {
                                config.files.push(src);
                            } else {
                                config.files.push({ source: src, destination: dst, recursive: Boolean(c.props.recursive) });
                            }
                        } else if (c.type === 'folder') {
                            const src = c.props.source || `visual-folder-${idx + 1}`;
                            const dst = c.props.destination || '$INSTDIR';
                            config.files.push({ source: src, destination: dst, recursive: Boolean(c.props.recursive) });
                        } else if (c.type === 'shortcut') {
                            if (!config.shortcuts) config.shortcuts = [];
                            config.shortcuts.push({
                                name: c.props.name || `Shortcut ${idx + 1}`,
                                target: c.props.target || '',
                                args: c.props.args || '',
                                icon: c.props.icon || '',
                                description: c.props.description || ''
                            });
                        }
                    });

                    onConfigChange();
                    ElMessage.success('Â∑≤Â∞ÜÂèØËßÜÂåñÈ°πÂ∫îÁî®Âà∞ÈÖçÁΩÆÔºàÂç≥Â∞ÜÂêåÊ≠•Âà∞ YAMLÔºâ');
                }
                // ----------------------------------------------------------
                
                // Load from YAML
                async function loadFromYaml() {
                    try {
                        const response = await fetch(`${API_BASE}/project/load`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ yaml_content: yamlContent.value })
                        });
                        
                        const data = await response.json();
                        
                        if (data.valid) {
                            // Update config without triggering watchers
                            isEditorChange = true;
                            Object.assign(config, data.config);

                            // Restore visual components if present in the loaded config
                            visualComponents.splice(0);

                            if (data.config && data.config.visual && Array.isArray(data.config.visual.components) && data.config.visual.components.length) {
                                // YAML explicitly contains visual components -> restore them
                                data.config.visual.components.forEach(c => visualComponents.push(c));
                            } else {
                                // No explicit visual section: try to derive canvas items from common config fields
                                if (data.config && data.config.shortcuts && Array.isArray(data.config.shortcuts)) {
                                    data.config.shortcuts.forEach((s, idx) => {
                                        visualComponents.push({ type: 'shortcut', props: {
                                            name: s.name || `Shortcut ${idx+1}`,
                                            target: s.target || '',
                                            args: s.args || '',
                                            icon: s.icon || '',
                                            description: s.description || ''
                                        }});
                                    });
                                }
                                if (data.config && data.config.files && Array.isArray(data.config.files)) {
                                    data.config.files.forEach((f, idx) => {
                                        if (typeof f === 'string') {
                                            visualComponents.push({ type: 'file', props: { source: f, destination: '$INSTDIR' } });
                                        } else if (f && f.source) {
                                            visualComponents.push({ type: 'file', props: { source: f.source, destination: f.destination || '$INSTDIR', recursive: Boolean(f.recursive) } });
                                        }
                                    });
                                }
                            }

                            // Ensure Monaco editor/layout updates after DOM changes
                            setTimeout(() => {
                                try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) { console.warn('editor.layout failed', e); }
                            }, 80);

                            yamlPreview.value = yamlContent.value;
                            validationStatus.valid = true;
                            validationStatus.message = 'ÈÖçÁΩÆÊúâÊïà';
                            setTimeout(() => { isEditorChange = false; }, 100);
                        } else {
                            validationStatus.valid = false;
                            validationStatus.message = data.errors[0]?.message || 'ÈÖçÁΩÆÊó†Êïà';
                        }
                    } catch (error) {
                        console.error('Error loading from YAML:', error);
                        validationStatus.valid = false;
                        validationStatus.message = 'Ëß£ÊûêÈîôËØØ';
                    }
                }
                
                // Config change handler
                function onConfigChange() {
                    if (!isEditorChange) {
                        syncToYaml();
                    }
                }
                
                // New project
                async function newProject() {
                    try {
                        const result = await ElMessageBox.prompt('ËØ∑ËæìÂÖ•È°πÁõÆÂêçÁß∞', 'Êñ∞Âª∫È°πÁõÆ', {
                            confirmButtonText: 'Á°ÆÂÆö',
                            cancelButtonText: 'ÂèñÊ∂à',
                            inputValue: 'MyApp'
                        });
                        
                        const response = await fetch(`${API_BASE}/project/new`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ name: result.value })
                        });
                        
                        const data = await response.json();
                        Object.assign(config, data.config);
                        syncToYaml();
                        ElMessage.success('È°πÁõÆÂàõÂª∫ÊàêÂäü');
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('Error creating project:', error);
                        }
                    }
                }
                
                // Load YAML file
                function loadYamlFile() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.yaml,.yml';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            yamlContent.value = event.target.result;
                            if (editor) {
                                editor.setValue(yamlContent.value);
                            }
                            loadFromYaml();
                            ElMessage.success('Êñá‰ª∂Âä†ËΩΩÊàêÂäü');
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                }
                
                // Download YAML
                function downloadYaml() {
                    const blob = new Blob([yamlContent.value], { type: 'text/yaml' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${config.app.name || 'installer'}.yaml`;
                    a.click();
                    URL.revokeObjectURL(url);
                    ElMessage.success('YAML Êñá‰ª∂Â∑≤‰∏ãËΩΩ');
                }
                
                // Validate YAML
                async function validateYaml() {
                    try {
                        const response = await fetch(`${API_BASE}/validate/yaml`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ yaml_content: yamlContent.value })
                        });
                        
                        const data = await response.json();
                        
                        if (data.valid) {
                            validationStatus.valid = true;
                            validationStatus.message = 'ÈÖçÁΩÆÊúâÊïà ‚úì';
                            ElMessage.success('ÈÖçÁΩÆÈ™åËØÅÈÄöËøá');
                        } else {
                            validationStatus.valid = false;
                            validationStatus.message = data.errors[0]?.message || 'ÈÖçÁΩÆÊó†Êïà';
                            ElMessage.error(`È™åËØÅÂ§±Ë¥•: ${data.errors[0]?.message}`);
                        }
                    } catch (error) {
                        console.error('Error validating:', error);
                        ElMessage.error('È™åËØÅËØ∑Ê±ÇÂ§±Ë¥•');
                    }
                }
                
                // Add file
                function addFile() {
                    newFile.source = '';
                    newFile.destination = '$INSTDIR';

                    addFileDialog.value = true;
                }
                
                function confirmAddFile() {
                    if (!newFile.source) {
                        ElMessage.warning('ËØ∑ËæìÂÖ•Ê∫êË∑ØÂæÑ');
                        return;
                    }
                    
                    if (!config.files) {
                        config.files = [];
                    }
                    
                    // Add as simple string or object
                    if (newFile.destination === '$INSTDIR') {
                        config.files.push(newFile.source);
                    } else {
                        config.files.push({
                            source: newFile.source,
                            destination: newFile.destination,

                        });
                    }
                    
                    addFileDialog.value = false;
                    onConfigChange();
                    ElMessage.success('Êñá‰ª∂Â∑≤Ê∑ªÂä†');
                }
                
                function removeFile(index) {
                    config.files.splice(index, 1);
                    onConfigChange();
                    ElMessage.success('Êñá‰ª∂Â∑≤Âà†Èô§');
                }
                
                // Registry functions
                function addRegistry() {
                    editingRegistryIndex = -1;
                    Object.assign(registryForm, {
                        hive: 'HKLM',
                        key: '',
                        name: '',
                        value: '',
                        type: 'REG_SZ',
                        view: ''
                    });
                    registryDialog.value = true;
                }
                
                function confirmRegistry() {
                    if (!registryForm.key || !registryForm.name) {
                        ElMessage.warning('ËØ∑ËæìÂÖ•ÈîÆË∑ØÂæÑÂíåÂÄºÂêçÁß∞');
                        return;
                    }
                    
                    if (!config.install) {
                        config.install = {};
                    }
                    if (!config.install.registry) {
                        config.install.registry = [];
                    }
                    
                    const entry = {
                        hive: registryForm.hive,
                        key: registryForm.key,
                        name: registryForm.name,
                        value: registryForm.value,
                        type: registryForm.type
                    };
                    
                    if (registryForm.view) {
                        entry.view = registryForm.view;
                    }
                    
                    if (editingRegistryIndex >= 0) {
                        config.install.registry[editingRegistryIndex] = entry;
                        ElMessage.success('Ê≥®ÂÜåË°®È°πÂ∑≤Êõ¥Êñ∞');
                    } else {
                        config.install.registry.push(entry);
                        ElMessage.success('Ê≥®ÂÜåË°®È°πÂ∑≤Ê∑ªÂä†');
                    }
                    
                    registryDialog.value = false;
                    onConfigChange();
                }
                
                function removeRegistry(index) {
                    config.install.registry.splice(index, 1);
                    onConfigChange();
                    ElMessage.success('Ê≥®ÂÜåË°®È°πÂ∑≤Âà†Èô§');
                }
                
                // Environment Variable functions
                function addEnvVar() {
                    editingEnvVarIndex = -1;
                    Object.assign(envVarForm, {
                        name: '',
                        value: '',
                        scope: 'user',
                        append: false
                    });
                    envVarDialog.value = true;
                }
                
                function confirmEnvVar() {
                    if (!envVarForm.name || !envVarForm.value) {
                        ElMessage.warning('ËØ∑ËæìÂÖ•ÂèòÈáèÂêçÂíåÂÄº');
                        return;
                    }
                    
                    if (!config.install) {
                        config.install = {};
                    }
                    if (!config.install.env_vars) {
                        config.install.env_vars = [];
                    }
                    
                    const entry = {
                        name: envVarForm.name,
                        value: envVarForm.value,
                        scope: envVarForm.scope,
                        append: envVarForm.append
                    };
                    
                    if (editingEnvVarIndex >= 0) {
                        config.install.env_vars[editingEnvVarIndex] = entry;
                        ElMessage.success('ÁéØÂ¢ÉÂèòÈáèÂ∑≤Êõ¥Êñ∞');
                    } else {
                        config.install.env_vars.push(entry);
                        ElMessage.success('ÁéØÂ¢ÉÂèòÈáèÂ∑≤Ê∑ªÂä†');
                    }
                    
                    envVarDialog.value = false;
                    onConfigChange();
                }
                
                function removeEnvVar(index) {
                    config.install.env_vars.splice(index, 1);
                    onConfigChange();
                    ElMessage.success('ÁéØÂ¢ÉÂèòÈáèÂ∑≤Âà†Èô§');
                }
                
                // Shortcut functions (dialog)
                function addShortcut() {
                    editingShortcutIndex = -1;
                    Object.assign(shortcutForm, {
                        name: '',
                        target: '',
                        args: '',
                        icon: '',
                        description: '',
                        working_dir: ''
                    });
                    shortcutDialog.value = true;
                }

                function confirmShortcut() {
                    if (!shortcutForm.name || !shortcutForm.target) {
                        ElMessage.warning('ËØ∑ËæìÂÖ•Âø´Êç∑ÊñπÂºèÂêçÁß∞ÂíåÁõÆÊ†áË∑ØÂæÑ');
                        return;
                    }

                    if (!config.shortcuts) {
                        config.shortcuts = [];
                    }

                    const entry = {
                        name: shortcutForm.name,
                        target: shortcutForm.target
                    };

                    if (shortcutForm.args) entry.args = shortcutForm.args;
                    if (shortcutForm.icon) entry.icon = shortcutForm.icon;
                    if (shortcutForm.description) entry.description = shortcutForm.description;
                    if (shortcutForm.working_dir) entry.working_dir = shortcutForm.working_dir;

                    if (editingShortcutIndex >= 0) {
                        config.shortcuts[editingShortcutIndex] = entry;
                        ElMessage.success('Âø´Êç∑ÊñπÂºèÂ∑≤Êõ¥Êñ∞');
                    } else {
                        config.shortcuts.push(entry);
                        ElMessage.success('Âø´Êç∑ÊñπÂºèÂ∑≤Ê∑ªÂä†');
                    }

                    shortcutDialog.value = false;
                    onConfigChange();
                }

                function removeShortcut(index) {
                    config.shortcuts.splice(index, 1);
                    onConfigChange();
                    ElMessage.success('Âø´Êç∑ÊñπÂºèÂ∑≤Âà†Èô§');
                }

                // ---------- Ë°åÂÜÖÁºñËæë„ÄÅÊãñÊãΩ‰∏éÂø´ÈÄüÊéíÂ∫èÔºàÈÄöÁî®Ôºâ ----------
                function startInlineRegistry(index) {
                    editingRegistryIndex = index;
                    Object.assign(registryForm, JSON.parse(JSON.stringify(config.install.registry[index] || {})));
                }

                function saveInlineRegistry(index) {
                    if (!registryForm.key || !registryForm.name) { ElMessage.warning('ÈîÆË∑ØÂæÑÂíåÂÄºÂêçÁß∞‰∏∫ÂøÖÂ°´'); return; }
                    config.install.registry[index] = Object.assign({}, registryForm);
                    editingRegistryIndex = -1; onConfigChange(); ElMessage.success('Ê≥®ÂÜåË°®È°πÂ∑≤‰øùÂ≠ò');
                }

                function cancelInlineRegistry() { editingRegistryIndex = -1; }

                function startInlineEnvVar(index) {
                    editingEnvVarIndex = index; Object.assign(envVarForm, JSON.parse(JSON.stringify(config.install.env_vars[index] || {})));
                }

                function saveInlineEnvVar(index) {
                    if (!envVarForm.name || !envVarForm.value) { ElMessage.warning('ÂèòÈáèÂêçÂíåÂÄº‰∏∫ÂøÖÂ°´'); return; }
                    config.install.env_vars[index] = Object.assign({}, envVarForm); editingEnvVarIndex = -1; onConfigChange(); ElMessage.success('ÁéØÂ¢ÉÂèòÈáèÂ∑≤‰øùÂ≠ò');
                }

                function cancelInlineEnvVar() { editingEnvVarIndex = -1; }

                function startInlineShortcut(index) { editingShortcutIndex = index; Object.assign(shortcutForm, JSON.parse(JSON.stringify(config.shortcuts[index] || {}))); }
                function saveInlineShortcut(index) { if (!shortcutForm.name || !shortcutForm.target) { ElMessage.warning('ÂêçÁß∞ÂíåÁõÆÊ†á‰∏∫ÂøÖÂ°´'); return; } config.shortcuts[index] = Object.assign({}, shortcutForm); editingShortcutIndex = -1; onConfigChange(); ElMessage.success('Âø´Êç∑ÊñπÂºèÂ∑≤‰øùÂ≠ò'); }
                function cancelInlineShortcut() { editingShortcutIndex = -1; }

                // Up / Down helpers (keyboard-friendly reorder)
                function moveRegistryUp() { if (!config.install?.registry?.length) return; const i = editingRegistryIndex >= 0 ? editingRegistryIndex : 0; if (i <= 0) return; const arr = config.install.registry; const el = arr.splice(i,1)[0]; arr.splice(i-1,0,el); onConfigChange(); }
                function moveRegistryDown() { if (!config.install?.registry?.length) return; const i = editingRegistryIndex >= 0 ? editingRegistryIndex : 0; const arr = config.install.registry; if (i >= arr.length-1) return; const el = arr.splice(i,1)[0]; arr.splice(i+1,0,el); onConfigChange(); }
                function moveEnvUp() { if (!config.install?.env_vars?.length) return; const i = editingEnvVarIndex >= 0 ? editingEnvVarIndex : 0; if (i <= 0) return; const arr = config.install.env_vars; const el = arr.splice(i,1)[0]; arr.splice(i-1,0,el); onConfigChange(); }
                function moveEnvDown() { if (!config.install?.env_vars?.length) return; const i = editingEnvVarIndex >= 0 ? editingEnvVarIndex : 0; const arr = config.install.env_vars; if (i >= arr.length-1) return; const el = arr.splice(i,1)[0]; arr.splice(i+1,0,el); onConfigChange(); }
                function moveShortcutUp() { if (!config.shortcuts?.length) return; const i = editingShortcutIndex >= 0 ? editingShortcutIndex : 0; if (i <= 0) return; const arr = config.shortcuts; const el = arr.splice(i,1)[0]; arr.splice(i-1,0,el); onConfigChange(); }
                function moveShortcutDown() { if (!config.shortcuts?.length) return; const i = editingShortcutIndex >= 0 ? editingShortcutIndex : 0; const arr = config.shortcuts; if (i >= arr.length-1) return; const el = arr.splice(i,1)[0]; arr.splice(i+1,0,el); onConfigChange(); }

                // Drag handlers
                function onListDragStart(section, index, ev) { dragState.section = section; dragState.index = index; try { ev.dataTransfer.effectAllowed = 'move'; } catch(e) {} }
                function onListDrop(section, index, ev) {
                    if (dragState.section !== section) return; if (dragState.index === index) return; let arr = null; if (section === 'registry') arr = config.install.registry; else if (section === 'env') arr = config.install.env_vars; else if (section === 'shortcut') arr = config.shortcuts; if (!arr) return; const el = arr.splice(dragState.index,1)[0]; const targetIndex = dragState.index < index ? index - 1 : index; arr.splice(targetIndex,0,el); dragState.index = -1; dragState.section = ''; onConfigChange(); }

                // Toggle compact mode (ÂáèÂ∞ëÂ∑¶‰æßÂç†Áî®Ôºå‰∏∫ÂèØËßÜÂåñÁîªÂ∏ÉÁïôÊõ¥Â§öÁ©∫Èó¥)
                function toggleCompact() {
                    compactMode.value = !compactMode.value;
                    ElMessage.info(compactMode.value ? 'Â∑≤ÂàáÊç¢Âà∞Á¥ßÂáëÊ®°Âºè' : 'Â∑≤ÂàáÊç¢Âà∞Â∏∏ËßÑÊ®°Âºè');
                    setTimeout(() => { try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) { console.warn('editor.layout failed', e); } }, 160);
                }

                function toggleLeftCollapse() {
                    leftCollapsed.value = !leftCollapsed.value;
                    ElMessage.info(leftCollapsed.value ? 'Â∑¶‰æßÂ∑≤ÊäòÂè†' : 'Â∑¶‰æßÂ∑≤Â±ïÂºÄ');
                    setTimeout(() => { try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) {} }, 180);
                }

                function toggleRightCollapse() {
                    rightCollapsed.value = !rightCollapsed.value;
                    ElMessage.info(rightCollapsed.value ? 'È¢ÑËßàÂ∑≤ÈöêËóè' : 'È¢ÑËßàÂ∑≤ÊòæÁ§∫');
                    setTimeout(() => { try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) {} }, 180);
                }

                // Auto-expand canvas when switching to visual tab
                watch(activeTab, (v) => {
                    if (v === 'visual' && autoCollapseOnVisual.value) {
                        // temporarily collapse side panels to maximize canvas
                        leftCollapsed.value = true;
                        rightCollapsed.value = true;
                        setTimeout(() => { try { if (editor && typeof editor.layout === 'function') editor.layout(); } catch (e) {} }, 200);
                    }
                });

                return {
                    activeTab,
                    config,
                    yamlPreview,
                    validationStatus,
                    addFileDialog,
                    newFile,
                    onConfigChange,
                    newProject,
                    loadYamlFile,
                    downloadYaml,
                    validateYaml,
                    addFile,
                    confirmAddFile,
                    removeFile,
                    compactMode,
                    toggleCompact,
                    // Collapse controls
                    leftCollapsed,
                    rightCollapsed,
                    autoCollapseOnVisual,
                    toggleLeftCollapse,
                    toggleRightCollapse,
                    // Visual editor bindings
                    visualComponents,
                    onDragStart,
                    onDrop,
                    removeVisual,
                    editVisual,
                    applyVisualToConfig,
                    visualEditDialog,
                    visualForm,
                    saveVisualEdit,
                    getVisualStatus,
                    // Registry bindings
                    registryDialog,
                    registryForm,
                    registrySearch,
                    filteredRegistry,
                    editingRegistryIndex,
                    addRegistry,
                    confirmRegistry,
                    removeRegistry,
                    startInlineRegistry,
                    saveInlineRegistry,
                    cancelInlineRegistry,
                    moveRegistryUp,
                    moveRegistryDown,
                    // Environment variable bindings
                    envVarDialog,
                    envVarForm,
                    envSearch,
                    filteredEnvVars,
                    editingEnvVarIndex,
                    addEnvVar,
                    confirmEnvVar,
                    removeEnvVar,
                    startInlineEnvVar,
                    saveInlineEnvVar,
                    cancelInlineEnvVar,
                    moveEnvUp,
                    moveEnvDown,
                    // Shortcut bindings
                    shortcutDialog,
                    shortcutForm,
                    shortcutSearch,
                    filteredShortcuts,
                    editingShortcutIndex,
                    addShortcut,
                    confirmShortcut,
                    removeShortcut,
                    startInlineShortcut,
                    saveInlineShortcut,
                    cancelInlineShortcut,
                    moveShortcutUp,
                    moveShortcutDown,
                    // List drag handlers
                    onListDragStart,
                    onListDrop
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>